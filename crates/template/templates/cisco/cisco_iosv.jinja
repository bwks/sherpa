!
hostname {{ hostname }}
ip domain name {{ dns.domain }}
{%- for server in dns.name_servers %}
ip name-server {{ server.ipv4_address }}
{%- endfor %}
crypto key generate rsa modulus 2048
ip ssh version 2
!
aaa new-model
aaa authentication login default local
aaa authorization exec default local
!
username {{ user.username }} privilege 15{% if let Some(password) = user.password %} secret {{ password }}{% endif %}
!
ip ssh pubkey-chain
  username {{ user.username }}
   key-hash {{ user.ssh_public_key.algorithm }} {{ user.ssh_public_key.key }}
!
ip scp server enable
!
archive
 log config
  logging enable
  logging size 1000
  notify syslog contenttype plaintext
 path flash:/archived-config
 maximum 14
 write-memory
 time-period 1440
!
interface {{ mgmt_interface }}
 {%- if let Some(mgmt_ipv4_address) = mgmt_ipv4_address %}
 ip address {{ mgmt_ipv4_address }} {{ mgmt_ipv4.subnet_mask }}
 {%- else %}
 ip address dhcp
 {%- endif %}
 no shutdown
 exit
!
ip route 0.0.0.0 0.0.0.0 {{ mgmt_ipv4.first }}
!
line con 0
 logging synchronous
 stopbits 1
 exit
!
line vty 0 4
 logging synchronous
 transport input ssh
 exit
!
event manager applet ENABLE-MGMT
 event syslog pattern "SYS-5-RESTART"
 action 0 cli command "enable"
 action 1 cli command "conf t"
 action 2 cli command "interface {{ mgmt_interface }}"
 action 3 cli command "no shutdown"
 action 4 cli command "exit"
 action 5 cli command "crypto key generate rsa modulus 2048"
!
exit