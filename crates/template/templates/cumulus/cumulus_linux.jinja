#!/bin/bash

# CUMULUS-AUTOPROVISIONING

function error() {
  echo -e "\e[0;33mERROR: The ZTP script failed while running the command $BASH_COMMAND at line $BASH_LINENO.\e[0m" >&2
  exit 1
}

# Log all output from this script
exec >> /var/log/autoprovision 2>&1
date "+%FT%T ztp starting script $0"

trap error ERR

#Configs
nv set system hostname {{ hostname }}
nv set service dns default search {{ dns.domain }}
{% for server in dns.name_servers %}
nv set service dns default server {{ server.ipv4_address }}
{% endfor %}
nv set system aaa user {{ user.username }}
{%- if let Some(password) = user.password %}
nv set system aaa user {{ user.username }} password '{{ password }}'
{%- endif %}
nv set system aaa user {{ user.username }} ssh authorized-key {{ user.username }}-ssh-key key {{ user.ssh_public_key.key }}
nv set system aaa user {{ user.username }} ssh authorized-key {{ user.username }}-ssh-key type {{ user.ssh_public_key.algorithm }}
{%- if user.sudo %}
nv set system aaa user {{ user.username }} role system-admin
{%- endif %}
{%- if let Some(mgmt_ipv4_address) = mgmt_ipv4_address %}
nv unset interface eth0 ip address dhcp
nv set interface eth0 ip address {{ mgmt_ipv4_address }}/{{ mgmt_ipv4.prefix_length }}
{%- else %}
nv set interface eth0 ip address dhcp
{%- endif %}
nv set interface eth0 ip gateway {{ mgmt_ipv4.first }}

nv config apply --assume-yes --message "ZTP config"

exit 0